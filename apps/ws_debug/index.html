<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Websocket Debug</title>
    <style>
      p {
        font-family: "Courier New", Courier, monospace;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <div
      style="
        width: 100vw;
        height: 100%;
        background: #1a1a1a;
        color: #ffffff;
        padding: 5px;
      "
      id="messages"
    ></div>
    <div style="display: flex">
      <input
        id="input_msg"
        style="flex-grow: 1"
        type="text"
        placeholder="Enter a message..."
      />
      <button onclick="sendMessage()">Send</button>
    </div>
    <div>
      <button onclick="createRoom()">Create Room</button>
      <button onclick="leaveRoom()">Leave Room</button>
      <button onclick="publish()">Publish stream</button>
    </div>
    <script>
      let maxTries = 5;
      let ws;
      let localPc = new RTCPeerConnection({
        iceServers: [{ urls: ["stun:stun2.l.google.com:19302"] }],
        bundlePolicy: "max-bundle",
      });
      localPc.addEventListener("icecandidate", (e) => {
        sendWs(
          `{"type": "icecandidate", "candidate": ${JSON.stringify(
            e.candidate
          )}}`
        );
      });

      const inputContainer = document.getElementById("input_msg");
      const messagesContainer = document.getElementById("messages");

      function addMessage(msg) {
        const text = document.createElement("p");
        text.innerText = msg;
        messagesContainer.append(text);
      }

      function sendMessage() {
        const msg = inputContainer.value;
        inputContainer.value = "";
        sendWs(msg);
      }

      function createRoom() {
        sendWs('{"type": "create_room"}');
      }

      function leaveRoom() {
        sendWs('{"type": "leave_room"}');
      }

      function sendWs(msg) {
        addMessage(`sent ${msg}`);
        ws.send(msg);
      }

      async function publish() {
        let stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: true,
        });

        let video = document.createElement("video");
        video.srcObject = stream;
        video.width = 400;
        video.onloadedmetadata = () => video.play();
        document.body.appendChild(video);

        stream.getTracks().forEach((track) => {
          localPc.addTrack(track);
        });
        const offer = await localPc.createOffer();
        await localPc.setLocalDescription(offer);

        sendWs(`{"type": "publish", "sdp_offer": ${JSON.stringify(offer)}}`);
      }

      async function finishPublish(msg) {
        let { sdp_answer } = msg;
        await localPc.setRemoteDescription(sdp_answer);
      }

      function connect() {
        if (maxTries === 0) {
          addMessage("no further connect retry (maxTries reached)");
          return;
        }
        maxTries--;

        addMessage("trying connecting to websocket server...");

        ws = new WebSocket("http://127.0.0.1:8888");
        ws.addEventListener("open", (e) => {
          addMessage(`websocket open state: ${JSON.stringify(e)}`);
          maxTries = 5;
        });

        ws.addEventListener("error", (e) => {
          addMessage(`websocket error state: ${JSON.stringify(e)}`);
        });

        ws.addEventListener("message", (e) => {
          addMessage(`websocket new message: ${e.data}`);
          const msg = JSON.parse(e.data);
          if (msg.type === "published") {
            finishPublish(msg);
          }
        });

        ws.addEventListener("close", (e) => {
          addMessage(`websocket close state: ${JSON.stringify(e)}`);
          setTimeout(() => {
            connect();
          }, 5000);
        });
      }

      connect();
    </script>
  </body>
</html>
